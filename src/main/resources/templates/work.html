<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>근무 - Nexus.team</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #chartContainer {
      width: 80%;
      margin: auto;
      padding-top: 50px;
    }
    .btn-container {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
    }
    #timer {
      font-size: 2em;
      margin-top: 20px;
      text-align: center;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="#">Nexus.team</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="#" id="employeeListBtn">구성원</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">급여</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/work">근무</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">휴가</a>
        </li>
      </ul>
    </div>
    <div class="d-flex align-items-center">
      <span class="me-3" th:text="${userName}"></span>
      <a class="btn btn-outline-danger" href="/logout">로그아웃</a>
    </div>
  </div>
</nav>

<div class="container mt-5">
  <div class="row">
    <div class="col-md-4">
      <h2>근무</h2>
      <ul id="departmentList" class="list-group">
        <!-- 내 근무 항목 추가 -->
        <li class="list-group-item">
          <a href="/work/myWork" class="text-decoration-none">내 근무</a>
        </li>
      </ul>
    </div>
    <div class="col-md-8" id="mainContent">
      <div class="mb-3 text-center">
        <button id="startWorkBtn" class="btn btn-success">출석</button>
        <button id="endWorkBtn" class="btn btn-danger hidden">퇴근</button>
        <div id="timer">00:00:00</div>
      </div>
      <div id="chartContainer">
        <canvas id="workHoursChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let startTime;
  let timerInterval;

  // 타이머 형식화 함수
  function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
  }

  // 타이머 시작 함수
  function startTimer() {
    timerInterval = setInterval(() => {
      const elapsedTime = Math.floor((new Date() - startTime) / 1000);
      document.getElementById('timer').textContent = formatTime(elapsedTime);
    }, 1000);
  }

  // 타이머 중지 함수
  function stopTimer() {
    clearInterval(timerInterval);
  }

  function parseJwt(token) {
    if (!token) {
      throw new Error('Token is null or undefined');
    }

    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(c => {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
  }

  // 출석 버튼 클릭 이벤트
  document.getElementById('startWorkBtn').addEventListener('click', function () {
    this.classList.add('hidden');
    document.getElementById('endWorkBtn').classList.remove('hidden');
    startTime = new Date(); // 출석 시간 기록
    localStorage.setItem('startTime', startTime); // 출석 시간을 로컬 스토리지에 저장
    startTimer();
  });

  // 퇴근 버튼 클릭 이벤트
  document.getElementById('endWorkBtn').addEventListener('click', function () {
    stopTimer();

    const endTime = new Date();
    const workTime = Math.floor((endTime - new Date(localStorage.getItem('startTime'))) / 1000); // 근무 시간 계산 (초 단위)

    // 근무 시간을 시, 분으로 변환
    const hours = Math.floor(workTime / 3600);
    const minutes = Math.floor((workTime % 3600) / 60);
    const timeWorked = `PT${hours}H${minutes}M`;

    // 근무 시간을 로컬 스토리지에 저장
    localStorage.setItem('workTime', workTime);

    const token = localStorage.getItem('token'); // 토큰 가져오기
    const requestData = {
      work_time: timeWorked
    };

    fetch('/api/work', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(requestData)
    })
            .then(response => response.json())
            .then(data => {
              console.log('응답 데이터:', data);
              if (data.statusCode === 200) {
                alert('근무 시간이 성공적으로 저장되었습니다.');
                localStorage.removeItem('startTime'); // 출석 시간 삭제
                location.reload(); // 페이지 새로고침
              } else {
                alert('근무 시간 저장에 실패하였습니다.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('근무 시간 저장 중 오류가 발생했습니다.');
            });
  });

  // 페이지 로드 시 출석 상태 확인
  document.addEventListener('DOMContentLoaded', function () {
    const token = localStorage.getItem('Authorization'); // 토큰 가져오기

    console.log(token);
    const decodedToken = parseJwt(token); // JWT 디코딩
    console.log(decodedToken);

    // 역할에 따라 회사 구성원 근무 링크 추가
    if (decodedToken.auth === 'MANAGER') {
      const companyWorkItem = document.createElement('li');
      companyWorkItem.className = 'list-group-item';
      companyWorkItem.innerHTML = '<a href="/work/companyWork" class="text-decoration-none">회사 구성원 근무</a>';
      document.getElementById('departmentList').appendChild(companyWorkItem);
    }
    console.log(new Date().toISOString().split('T')[0]);
    fetch('/api/work/today-status', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ date: getKoreanDate() }) // 현재 날짜 전달
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              console.log('서버 응답:', data); // 응답 로그로 확인

              if (data.data) { // 이미 퇴근 완료된 상태
                document.getElementById('startWorkBtn').classList.add('hidden');
                document.getElementById('endWorkBtn').classList.add('hidden');

                // 퇴근 완료 메시지와 퇴근 시간 표시
                const endTimeMessage = document.createElement('div');
                endTimeMessage.textContent = '퇴근이 완료되었습니다';
                endTimeMessage.style.fontSize = '2em';
                endTimeMessage.style.textAlign = 'center';
                endTimeMessage.style.color = '#28a745'; // 텍스트 색상 (녹색)
                endTimeMessage.style.marginTop = '20px'; // 상단 여백 추가

                // 근무 시간 표시
                const storedWorkTime = localStorage.getItem('workTime');
                const totalTimeWorked = formatTime(parseInt(storedWorkTime)); // 총 근무 시간 형식화
                const endTimeDisplay = document.createElement('div');
                endTimeDisplay.textContent = `근무 시간: ${totalTimeWorked}`;
                endTimeDisplay.style.fontSize = '1.5em';
                endTimeDisplay.style.textAlign = 'center';
                endTimeDisplay.style.color = '#333'; // 텍스트 색상 (진한 회색)
                endTimeDisplay.style.marginTop = '10px'; // 상단 여백 추가

                // 두 요소를 DOM에 추가
                const mainContent = document.getElementById('mainContent');
                mainContent.appendChild(endTimeMessage);
                mainContent.appendChild(endTimeDisplay);

                // 타이머 영역에 추가
                const timerElement = document.getElementById('timer');
                timerElement.innerHTML = ''; // 기존 타이머 지우기
                timerElement.appendChild(endTimeMessage);
                timerElement.appendChild(endTimeDisplay);
              } else { // 출석 중인 상태
                const storedStartTime = localStorage.getItem('startTime');
                if (storedStartTime) { // 이미 출석 중이었던 경우
                  startTime = new Date(storedStartTime);
                  document.getElementById('startWorkBtn').classList.add('hidden');
                  document.getElementById('endWorkBtn').classList.remove('hidden');
                  startTimer();
                } else {
                  document.getElementById('startWorkBtn').classList.remove('hidden');
                  document.getElementById('endWorkBtn').classList.add('hidden');
                }
              }
            })
            .catch(error => {
              console.error('Error fetching work status:', error);
            });
  });

  // 한국 시간을 반환하는 함수
  function getKoreanDate() {
    const now = new Date();
    const kstOffset = 9 * 60 * 60 * 1000; // 9시간(UTC+9) 밀리초
    const kstDate = new Date(now.getTime() + kstOffset);
    return kstDate.toISOString().split('T')[0]; // 'YYYY-MM-DD' 형식의 날짜 반환
  }



</script>
</body>
</html>
