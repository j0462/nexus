<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>사원 근무</title>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="#">Nexus.team</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="#" id="employeeListBtn">구성원</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">급여</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/work">근무</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">휴가</a>
        </li>
      </ul>
    </div>
    <div class="d-flex align-items-center">
      <span class="me-3" id="userName"></span>
      <a class="btn btn-outline-danger" href="/logout">로그아웃</a>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h1>사원 근무 조회</h1>
  <div class="row mb-4">
    <div class="col-md-4">
      <label for="viewType" class="form-label">조회 유형</label>
      <select class="form-select" id="viewType">
        <option value="daily">일별 조회</option>
        <option value="monthly">월별 조회</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="dateInput" class="form-label" id="dateLabel">날짜</label>
      <input type="date" class="form-control" id="dateInput">
    </div>
    <div class="col-md-4">
      <button class="btn btn-primary mt-4" onclick="fetchWorkData()">조회</button>
    </div>
  </div>

  <div id="workTableContainer">
    <!-- 근무 조회 결과 테이블이 여기에 표시됩니다 -->
  </div>
</div>

<script>
  // 조회 유형에 따라 날짜 입력 필드와 라벨을 변경
  document.getElementById('viewType').addEventListener('change', function () {
    const viewType = this.value;
    const dateInput = document.getElementById('dateInput');
    const dateLabel = document.getElementById('dateLabel');

    if (viewType === 'daily') {
      dateLabel.textContent = '날짜';
      dateInput.type = 'date';
    } else if (viewType === 'monthly') {
      dateLabel.textContent = '월 선택';
      dateInput.type = 'month';
    }
  });

  // 근무 데이터 조회를 위한 함수 (API 요청)
  function fetchWorkData() {
    const viewType = document.getElementById('viewType').value;
    const dateValue = document.getElementById('dateInput').value;
    const companyId = getCompanyIdFromToken(); // 토큰에서 company_id 추출

    // API 엔드포인트 설정
    let apiUrl = `/api/work/${companyId}`;

    if (viewType === 'daily') {
      apiUrl += `/today`;
    } else if (viewType === 'monthly') {
      apiUrl += `/month`;
    }

    // API 요청
    fetch(apiUrl, {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + getAuthToken(), // 토큰을 헤더에 포함
        'Content-Type': 'application/json'
      }
    })
            .then(response => response.json())
            .then(data => {
              displayWorkData(data, viewType);
            })
            .catch(error => console.error('Error fetching work data:', error));
  }

  // 근무 데이터를 테이블 형식으로 표시하는 함수
  function displayWorkData(workData, viewType) {
    const container = document.getElementById('workTableContainer');
    container.innerHTML = '';

    let tableHTML = '<table class="table">';
    tableHTML += '<thead><tr>';

    if (viewType === 'daily') {
      tableHTML += '<th>사원 이름</th><th>근무 시간</th><th>근무 유형</th><th>삭제</th>';
    } else {
      tableHTML += '<th>날짜</th><th>근무 유형</th><th>삭제</th>';
    }

    tableHTML += '</tr></thead><tbody>';

    workData.content.forEach((data) => {  // workData.content로 페이지 응답 처리
      tableHTML += '<tr>';

      if (viewType === 'daily') {
        tableHTML += `<td>${data.employeeName}</td><td>${data.workTime}</td><td>${data.salaryType}</td>`;
      } else {
        tableHTML += `<td>${data.workDate}</td><td>${data.salaryType}</td>`;
      }

      tableHTML += `<td><button class="btn btn-danger" onclick="deleteWork(${data.id})">삭제</button></td>`;
      tableHTML += '</tr>';
    });

    tableHTML += '</tbody></table>';

    container.innerHTML = tableHTML;
  }

  // 근무 데이터 삭제 함수
  function deleteWork(id) {
    const companyId = getCompanyIdFromToken(); // company_id 추출

    fetch(`/api/work/${companyId}/delete/${id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + getAuthToken(),
        'Content-Type': 'application/json'
      }
    })
            .then(response => {
              if (response.ok) {
                alert('근무 기록이 삭제되었습니다.');
                fetchWorkData(); // 데이터를 다시 로드하여 업데이트
              } else {
                alert('삭제 중 오류가 발생했습니다.');
              }
            })
            .catch(error => console.error('Error deleting work data:', error));
  }

  // 토큰에서 company_id 추출하는 함수
  function getCompanyIdFromToken() {
    const token = getAuthToken();
    const payload = JSON.parse(atob(token.split('.')[1])); // JWT 토큰의 payload 부분을 디코드
    return payload.company_id; // company_id가 payload에 있다고 가정
  }

  // 토큰을 가져오는 함수 (로컬 스토리지 또는 다른 저장소에서)
  function getAuthToken() {
    return localStorage.getItem('Authorization'); // 예시로 로컬스토리지에서 가져옴
  }
</script>

</body>

</html>
